# CAD任务会话监控使用说明

## 📋 概述

通过信号文件 `可以结束对话.txt` 实现任务完成自动检测。

---

## 🔧 工作机制

### 信号文件

**路径**：`D:\claude-tasks\cad\可以结束对话.txt`

**状态**：
- `0` = 任务进行中
- `1` = 任务已完成

### 工作流程

```
1. 监控脚本启动 → 设置信号为 0
2. Claude执行任务 → 信号保持 0
3. 任务完成 → Claude设置信号为 1
4. 监控脚本检测到 1 → 提示任务完成
5. 监控脚本重置信号为 0 → 准备下次任务
```

---

## 🚀 使用方法

### 方法一：使用Python监控脚本（推荐）

```bash
# 基本使用（5秒检查一次）
python D:\claude-tasks\cad\monitor_session.py

# 自定义检查间隔（10秒）
python D:\claude-tasks\cad\monitor_session.py --interval 10

# 启用自动关闭（需要自行实现关闭逻辑）
python D:\claude-tasks\cad\monitor_session.py --auto-close
```

**输出示例**：
```
============================================================
CAD任务会话监控
============================================================

✅ 已重置信号文件为0: D:\claude-tasks\cad\可以结束对话.txt

🔍 开始监控（检查间隔: 5秒）
📁 监控文件: D:\claude-tasks\cad\可以结束对话.txt
🔔 自动关闭: 否

按 Ctrl+C 停止监控

⏱ 已监控 50秒 - 等待任务完成...

============================================================
✅ 检测到任务完成信号！
============================================================

✅ 已重置信号文件为0: D:\claude-tasks\cad\可以结束对话.txt

📝 请手动关闭对话窗口

✅ 监控结束
```

---

### 方法二：使用PowerShell脚本

创建 `monitor.ps1`：

```powershell
# 监控信号文件
$signalFile = "D:\claude-tasks\cad\可以结束对话.txt"

# 启动时重置为0
Set-Content -Path $signalFile -Value "0"
Write-Host "✅ 已重置信号文件为0" -ForegroundColor Green

Write-Host "`n🔍 开始监控..." -ForegroundColor Cyan

while ($true) {
    $content = Get-Content -Path $signalFile

    if ($content -eq "1") {
        Write-Host "`n============================================================" -ForegroundColor Green
        Write-Host "✅ 检测到任务完成信号！" -ForegroundColor Green
        Write-Host "============================================================" -ForegroundColor Green

        # 重置信号
        Set-Content -Path $signalFile -Value "0"

        Write-Host "`n📝 请手动关闭对话窗口" -ForegroundColor Yellow
        break
    }

    Start-Sleep -Seconds 5
}
```

运行：
```powershell
powershell -ExecutionPolicy Bypass -File monitor.ps1
```

---

### 方法三：使用批处理脚本

创建 `monitor.bat`：

```batch
@echo off
setlocal enabledelayedexpansion

set SIGNAL_FILE=D:\claude-tasks\cad\可以结束对话.txt

:: 启动时重置为0
echo 0 > "%SIGNAL_FILE%"
echo [成功] 已重置信号文件为0

echo.
echo [监控] 开始监控任务完成状态...
echo.

:check
set /p content=<"%SIGNAL_FILE%"

if "%content%"=="1" (
    echo ============================================================
    echo [完成] 检测到任务完成信号！
    echo ============================================================

    :: 重置信号
    echo 0 > "%SIGNAL_FILE%"

    echo.
    echo [提示] 请手动关闭对话窗口
    goto end
)

timeout /t 5 /nobreak >nul
goto check

:end
pause
```

运行：
```batch
monitor.bat
```

---

## 📊 Claude端实现

Claude在任务完成后会自动执行：

```python
# 任务完成后设置信号
with open("D:/claude-tasks/cad/可以结束对话.txt", "w", encoding="utf-8") as f:
    f.write("1")

print("✅ 已设置结束信号")
```

这已经写入 `CLAUDE.md` 规范，Claude会自动遵循。

---

## ⚙️ 高级用法

### 集成到工作流

```bash
# 启动监控脚本（后台运行）
start python D:\claude-tasks\cad\monitor_session.py

# 启动Claude对话
claude-code chat

# 监控脚本会自动检测任务完成
```

### 自定义处理逻辑

修改 `monitor_session.py` 中的处理逻辑：

```python
if check_signal():
    print("✅ 任务完成")

    # 自定义处理
    # 1. 发送通知
    # 2. 记录日志
    # 3. 触发下一个任务
    # 4. 关闭窗口

    return 0
```

---

## 🔍 故障排查

### 问题1：信号文件不存在

**解决**：监控脚本会自动创建

### 问题2：信号一直是0

**原因**：Claude未完成任务或未设置信号

**检查**：
1. 查看Claude是否还在执行任务
2. 检查是否有错误输出
3. 确认CLAUDE.md规范已更新

### 问题3：监控脚本无法读取文件

**解决**：检查文件路径和权限

```bash
# 检查文件是否存在
dir "D:\claude-tasks\cad\可以结束对话.txt"

# 查看文件内容
type "D:\claude-tasks\cad\可以结束对话.txt"
```

---

## 📝 注意事项

1. **监控脚本必须先启动**：在开始Claude任务前启动监控
2. **信号文件不要手动修改**：由脚本自动管理
3. **每次任务前重置**：监控脚本启动时自动重置为0
4. **多任务场景**：每个任务完成后都会设置为1

---

## ✅ 完整工作流示例

```bash
# 1. 启动监控脚本
python D:\claude-tasks\cad\monitor_session.py

# 2. 在另一个终端启动Claude
claude-code chat

# 3. 在Claude中执行任务
/jst

# 4. 等待监控脚本提示任务完成
# 输出：✅ 检测到任务完成信号！

# 5. 手动关闭Claude对话窗口

# 6. 开始下一个任务（监控脚本已自动重置信号为0）
```

---

**现在你可以使用监控脚本自动检测任务完成状态了！**
