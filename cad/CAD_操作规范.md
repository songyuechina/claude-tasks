# CAD 自动化操作规范

基于 `D:/claude-tasks/ziliao/20251010-0143-CAD开发` 资料整理的CAD操作规范,每次工作任务必须遵循。

## 🎯 CAD软件操作六大核心规则

### 1. 启动方式
**通过天正软件启动CAD,不直接启动CAD**
- 启动路径:`C:/Tangent/TArchT20V9/TGStart.exe`
- 这将同时打开天正V9和CAD2021界面
- 天正V9基于CAD开发,提供完整的CAD功能

### 2. CAD软件四个核心状态

#### 单文件不确定状态
- **定义**:单进程 + 仅1张未保存空白图
- **特点**:不关心具体是哪张图,必要时自动新建
- **用途**:测试/任务前归位、恢复异常现场
- **实现**:`CadController.single_unsaved_state()`

#### 单文件确定状态
- **定义**:单进程 + 仅1张"指定/当前"DWG保留在前台,其他全部关闭
- **特点**:只对一个确切目标图进行操作
- **用途**:单一文件精确操作
- **实现**:`CadController.standardize_state(target_doc_path=None)`

#### 双文件确定状态
- **定义**:单进程 + 仅2张"指定"DWG保留在前台,可选择激活A/B
- **特点**:需要A/B对照或跨图操作
- **用途**:文件对比、参照操作
- **实现**:`CadController.standardize_two_documents(a,b,active=None)`

#### 多文件状态
- **定义**:单进程 + 打开不限数量的DWG文件数
- **特点**:一个CAD进程处理多个文件
- **约束**:**禁止**打开多个同一文件,避免只读文件混乱

### 3. 物理驱动等待机制
**CAD是物理驱动Windows系统的软件,命令执行需要时间**
- **关键原则**:脚本命令发出后,必须等待CAD软件运行该命令结束才能执行下一个脚本命令
- **实现方法**:
  - `wait_quiescent(min_quiet≈0.4s, timeout)`:等待CAD空闲
  - `wait_document_opened(path)`:等待文档加入acad.Documents
  - 连续操作间插入≈0.3s微等待

### 4. 弹窗治理机制
**CAD操作会因各种原因弹出窗口,如不回应会停止运行**
- **启动时机**:每次工作任务开始后第一次启动CAD时立即启动
- **治理脚本**:`D:/claude-tasks/scripts/cad_dialog_killer.py`
- **工作机制**:无限循环程序,捕捉CAD运行中产生的各种窗口,等待15秒后强制关闭
- **目的**:防止弹窗影响CAD正常运行

### 5. 统一操作入口
**所有操作CAD的命令都放在CAD-basic.py**
- **位置**:`D:/claude-tasks/scripts/CAD-basic.py`
- **目标**:不断完善此脚本,作为操作CAD的统一接口
- **原则**:CAD相关的所有功能都通过此脚本实现

### 6. 进程约束策略
- **默认(非破坏性)**:
  - `cnt==0`:启动CAD
  - `cnt>1`:收敛到单进程
  - `cnt==1`:等待空闲
- **严格场景**:调用`single_unsaved_state()`完全重置

## ⚡ 协同机制核心要求

### 时序控制
1. **命令顺序执行**:确保前一个命令完全结束后才执行下一个
2. **等待策略**:每个操作后必须等待CAD空闲状态
3. **容错机制**:异常时最多重试5次

### 幂等性保证
1. **路径级幂等**:相同路径已打开则不再重复打开
2. **名称级保护**:同名文档存在则跳过,避免只读副本
3. **状态恢复**:每次测试后归位到"单文件不确定状态"

### 错误处理
1. **弹窗处理**:自动检测和关闭干扰弹窗
2. **超时控制**:设置合理的操作超时时间
3. **日志记录**:完整记录操作过程和错误信息

---

**重要提醒**:每次开始新的CAD操作任务前,必须重新阅读此规范,确保严格遵循所有规则!