天正窗函数实现状态报告
生成时间: 2025-11-10
================================================================================

## 任务要求（来自即时对话.txt）
在已有天正墙经过的任意点，插入指定宽度的指定类型的窗。
测试：在天正测试文件2.dwg中，绘制三角形墙体（厚度200），插入3个窗：
  - 宽900，类型3
  - 宽1200，类型7
  - 宽2000，类型9

## 已完成的工作

### 1. 函数实现 ✓
文件位置: D:\claude-tasks\scripts\CAD_file_operations.py (第421-513行)

函数签名:
```python
def insert_tarch_window(p, width, window_type=1):
    """
    在墙体上插入天正窗

    Args:
        p: 插入点坐标 (x, y, z)
        width: 窗宽
        window_type: 窗类型编号 (1-10)

    Returns:
        dict: {'success': bool, 'window': 窗对象, 'width': 宽度}
    """
```

实现的4步流程:
1. 使用TOpening命令插入门作为基础
2. 将MC_yuan.dwg以炸开方式插入到原点(0,0,0)
3. 根据窗类型编号选择对应坐标范围的窗实体
4. 使用transfer_props_by_matchprop将窗属性传递给门

### 2. 测试脚本 ✓
文件位置: D:\claude-tasks\test_triangle_windows.py

测试内容:
- 启动天正CAD
- 打开天正测试文件2.dwg
- 绘制3个三角形墙体（厚度200）
- 在每堵墙中间插入指定类型的窗
- 保存文件

### 3. 测试结果

#### 成功部分 ✓
- CAD启动和文件打开: 成功
- 三角形墙体绘制: 成功（3堵墙，厚度200）
- 门对象插入: 成功
- MC_yuan.dwg插入: 成功

#### 失败部分 ✗
- 窗实体选择: 失败（选择到0个对象）
- 所有3个窗插入均失败

## 问题分析

### 核心问题
select_entities_in_window() 函数在指定坐标范围内选择不到任何对象。

测试输出显示:
```
[调试] 选择到 0 个对象
[警告] 未选中窗类型3，坐标: (39060, 527163, 0) 到 (41693, 524872, 0)
```

### 可能原因
1. MC_yuan.dwg中的窗实体坐标与提供的坐标不匹配
2. 炸开插入后实体位置发生了变化
3. 坐标系统不一致（可能是UCS vs WCS）
4. 实体类型或图层导致选择失败

### 次要问题
清理策略使用了"_ERASE ALL"命令，在第一个窗失败后删除了所有实体（包括墙体），
导致后续窗插入时ModelSpace为空，引发COM错误。

## 需要解决的问题

### 优先级1: 验证MC_yuan.dwg坐标
需要:
1. 打开MC_yuan.dwg文件
2. 查看实际窗实体的坐标范围
3. 确认10种窗类型的正确坐标映射
4. 更新window_coords字典中的坐标值

### 优先级2: 改进清理策略
当前代码在选择失败时使用"_ERASE ALL"，这会删除所有内容。
建议改为:
- 只删除MC_yuan坐标范围内的对象
- 或者使用图层过滤
- 或者记录插入前的对象数量，只删除新增对象

### 优先级3: 增强错误处理
- 在选择失败时不要删除已有墙体和门
- 添加更详细的调试信息
- 考虑添加重试机制

## 调试工具

已创建调试脚本: D:\claude-tasks\test_mc_yuan_coords.py
用途:
- 插入MC_yuan.dwg
- 打印所有对象的坐标范围
- 测试选择窗类型3的坐标
- 显示选中的对象信息

注意: 该脚本在运行时卡在"正在创建新文件"阶段，可能需要检查new_file()函数。

## 代码位置总结

1. 主函数: D:\claude-tasks\scripts\CAD_file_operations.py
   - insert_tarch_window() (第421-513行)

2. 依赖函数:
   - insert_file_exploded() - 炸开插入文件
   - select_entities_in_window() - 窗口选择实体 (CAD_basic.py)
   - transfer_props_by_matchprop() - 属性传递 (CAD_basic.py)
   - last_obj() - 获取最后对象 (CAD_basic.py, 第3257-3261行)

3. 测试文件:
   - test_triangle_windows.py - 主测试脚本
   - test_mc_yuan_coords.py - 坐标验证脚本

## 建议的下一步行动

1. 手动打开MC_yuan.dwg，使用CAD的LIST命令查看窗实体的实际坐标
2. 更新window_coords字典中的坐标值
3. 移除或修改"_ERASE ALL"清理逻辑
4. 重新运行test_triangle_windows.py测试
5. 如果坐标问题难以解决，考虑使用其他选择方法（如按对象类型、图层或属性选择）

## 总结

函数框架和逻辑已完整实现，核心问题是MC_yuan.dwg中窗实体的坐标映射不正确。
一旦坐标问题解决，函数应该能够正常工作。

建议优先验证MC_yuan.dwg的实际坐标，然后更新代码中的坐标映射。
