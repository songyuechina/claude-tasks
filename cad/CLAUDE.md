# CAD项目文档规范

**版本**: v1.3
**更新日期**: 2025-11-14
**适用范围**: D:\claude-tasks\cad 目录

---

## ⚠️ 强制执行规则（违反=任务失败）

以下规则具有**最高优先级**，任何情况下都不得违反：

| 优先级 | 规则 | 执行时机 | 违反后果 |
|-------|------|---------|---------|
| 🔴 P0 | **任务完成前必须调用`cad_zt_zero()`** | 每次汇报"任务完成"前 | 任务判定为失败 |
| 🔴 P0 | 测试前后必须调用`cad_zt_zero()` | 测试开始前&结束后 | 测试无效 |
| 🔴 P0 | 超过60秒立即终止 | 任何命令执行中 | 立即调用cad_zt_oneb() |
| 🟠 P1 | 文件操作必须用CAD_file_operations.py | 所有文件操作 | 代码需重写 |
| 🟠 P1 | 天正操作必须用规定函数 | 绘墙/门/窗 | 代码需重写 |

### ⚠️ 条件执行规则（仅在任务明确要求时）

以下规则**不是默认操作**，仅在任务中明确包含特定字段时才执行：

| 规则 | 执行条件 | 触发字段 | 警告 |
|------|---------|---------|------|
| 🔔 设置结束信号为1 | **仅在任务中有"### 关机信号"字段** | `### 关机信号` | ⚠️ **会触发系统关机！** |

**❌ 禁止行为**：
- **绝对不能**在没有"### 关机信号"字段的任务中设置`可以结束对话.txt`为1
- **绝对不能**默认执行关机信号设置
- 违反将导致：**严重错误（触发意外关机）**

### 🚨 三清理规则（最容易遗忘！）

**每次测试任务必须执行三次`cad_zt_zero()`清理**：

1. **测试开始前**：清理CAD状态
2. **测试脚本结束时**：在finally块清理
3. **🔴 任务完成汇报前**：再次清理（最容易遗忘！）

### 📋 任务完成前强制检查清单

在说"任务完成"之前，必须逐项确认：

- [ ] 测试开始前是否调用了`cad_zt_zero()`？
- [ ] 测试脚本是否有finally块调用`cad_zt_zero()`？
- [ ] **🔴 任务完成后是否再次调用了`cad_zt_zero()`？**
- [ ] 是否使用了`CAD_file_operations.py`进行文件操作？
- [ ] 天正操作是否使用了规定函数？

**如果以上任何一项未确认，不得汇报"任务完成"！**

**🔔 条件检查项（仅在任务有特殊要求时）**：
- [ ] ⚠️ **仅当任务中明确包含"### 关机信号"字段时**，才将`可以结束对话.txt`设置为`1`
- [ ] ⚠️ **如果任务中没有此字段，绝对不能设置为1！**

### 🔔 会话结束信号文件（条件执行）

**文件路径**：`D:\claude-tasks\cad\可以结束对话.txt`

**⚠️ 重要：设置为1会触发系统关机！**

**执行条件**：
- **仅当任务描述中明确包含以下字段时才执行**：
  ```markdown
  ### 关机信号
  该任务结束后强制将 D:/claude-tasks/cad/可以结束对话.txt的内容改为1
  ```
- **如果任务中没有此字段，绝对不能设置为1！**

**工作机制**：
- 监控脚本启动时设置为 `0`
- 仅在任务有"关机信号"字段时设置为 `1`
- 用户监控脚本检测到 `1` 后自动关闭对话并关机

**设置方法**（仅在条件满足时执行）：
```python
# ⚠️ 仅在任务中有"### 关机信号"字段时执行
with open("D:/claude-tasks/cad/可以结束对话.txt", "w", encoding="utf-8") as f:
    f.write("1")
```

### 📊 进度汇报和状态检查机制

#### 1. 任务开始时的期望设置

**触发条件判断原则**：

任务描述中同时包含以下两个要素即触发进度汇报机制：
1. **明确的时间间隔**（如"每隔10分钟"、"每10分钟"、"10分钟一次"）
2. **汇报/报告动作**（如"汇报进度"、"报告进展"、"更新进度"、"通报情况"）

**触发示例**：
- ✓ "请每隔10分钟汇报进度"
- ✓ "每10分钟报告一次进展"
- ✓ "这个任务需要每隔10分钟更新进度"
- ✓ "10分钟汇报一次任务状态"
- ✓ "任务执行过程中每隔5分钟通报情况"

**不触发示例**：
- ✗ "及时汇报进度"（无明确时间间隔）
- ✗ "每隔10分钟检查一次"（无汇报动作）
- ✗ "尽量多汇报进度"（无明确时间间隔）
- ✗ "任务完成后汇报"（不是定期汇报）

**标准格式参考**：
```markdown
<任务>
{任务内容...}

**进度汇报要求**：
请每隔 {Y} 分钟汇报进度
</任务>
```

**我的执行**（仅当满足触发条件时）：
- 按要求的时间间隔主动汇报进度
- 汇报格式：`[进度] 正在执行步骤X/Y：{当前操作}`
- **同时每60秒写入心跳时间戳到任务进度汇报.txt**

#### 2. 🔔 心跳监控机制（条件执行）

**⚠️ 重要**：心跳监控**不是默认操作**，仅在特定条件下执行

**触发条件判断**：
- 与"任务开始时的期望设置"使用相同的判断原则
- 任务描述中同时包含**明确的时间间隔** + **汇报/报告动作**即触发

**文件路径**：`D:\claude-tasks\cad\任务进度汇报.txt`

**写入内容**：仅时间戳，不需要其他信息

**实现代码**（仅在条件满足时执行）：
```python
from datetime import datetime

# 每60秒执行一次
with open("D:/claude-tasks/cad/任务进度汇报.txt", "a", encoding="utf-8") as f:
    f.write(f"{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n")
```

**目的**：
- 区分网络卡顿还是CAD命令卡住
- 监控Python进程是否正常运行
- 帮助诊断任务停滞原因

**监控逻辑**：
- 时间戳持续更新 → 网络和Python正常，问题在CAD命令
- 时间戳停止更新 → 网络或Python进程卡住
- 时间戳间隔不规律 → 网络延迟波动

**执行规则总结**：
- **满足触发条件**（时间间隔 + 汇报动作）→ 启动心跳监控 + 按时汇报进度
- **不满足触发条件** → 不写心跳，不汇报进度（简单任务直接完成）

#### 3. 用户主动状态检查

**适用范围**：所有任务（无论是否要求汇报进度）

当用户发送消息：
```
状态检查：是否遇到问题？
```

**我必须立即回应**（不得忽略）：

**正常情况**：
```
[状态] 一切正常
[当前] 正在执行：{具体任务}
[进度] 步骤 {X}/{Y}
[预计] 还需 {Z} 分钟
```

**异常情况**：
```
[状态] 遇到问题
[问题] {具体问题描述}
[位置] {出错位置}
[尝试] {已尝试的解决方法}
[需要] {需要用户提供的帮助}
```

#### 4. 主动进度汇报格式

**适用范围**：仅当任务要求"请每隔X分钟汇报进度"时

**标准格式**：
```
[进度] 步骤 {X}/{Y}：{当前操作}
[状态] {正常/等待/处理中}
[耗时] 已执行 {X} 秒
[预计] 还需 {Y} 秒
```

**示例**：
```
[进度] 步骤 2/5：绘制天正墙
[状态] 等待CAD命令完成
[耗时] 已执行 25 秒
[预计] 还需 15 秒
```

#### 5. 长时间操作的特殊汇报

**适用范围**：仅当任务要求"请每隔X分钟汇报进度"时

如果某个操作预计超过30秒：

```
[提示] 即将执行长时间操作
[操作] {操作名称}
[预计] 约需 {X} 秒
[开始] {时间戳}

... 执行中 ...

[完成] {操作名称}
[实际] 耗时 {X} 秒
```

#### 6. 汇报频率规则

**⚠️ 重要前提**：以下规则仅适用于用户明确要求汇报进度的任务

| 任务类型 | 参考汇报频率 | 说明 |
|---------|------------|------|
| 简单任务（<5分钟） | 不需要汇报 | 用户一般不会要求汇报 |
| 中等任务（5-15分钟） | 每3分钟 | 用户可能要求汇报 |
| 长任务（>15分钟） | 每5分钟 | 用户通常要求汇报 |
| 超长任务（>30分钟） | 每5分钟 | 用户通常要求汇报 |

**执行规则**：
- **用户明确指定汇报频率**（如"请每隔X分钟汇报进度"）→ 以用户要求为准
- **用户没有要求汇报** → 不汇报进度，不写心跳时间戳

#### 7. 响应"状态检查"的优先级

**适用范围**：所有任务（无论是否要求汇报进度）

收到"状态检查：是否遇到问题？"消息时：

- 🔴 **最高优先级**：立即停止当前输出
- 🔴 **必须回应**：不得忽略此消息
- 🔴 **格式规范**：使用标准格式回应
- 🔴 **信息完整**：包含当前状态、进度、预计时间

**禁止的回应**：
- ❌ "继续工作中"（信息不足）
- ❌ 不回应（违反规范）
- ❌ "请稍等"（必须说明在做什么）

---

## 一、行为规范

本文档定义CAD项目的特定规范，补充 `D:\claude-tasks\CLAUDE.md` 的通用规范。CAD项目特定规范优先级高于通用规范。

---

## 二、语言规范

都是用中文回复。

---

## 三、CAD项目目录结构

```
cad/
├── scripts/              # 核心脚本（CAD_basic.py, CAD_file_operations.py）
├── system/               # 系统模块（协同机制、范式函数）
├── tests/                # 测试脚本（100%覆盖率）
├── test_reports/         # 测试报告（Excel格式）
├── examples/             # 示例代码
├── project_scripts/      # 项目脚本
├── annotation_scripts/   # 标注脚本
├── xitongwenjian/        # 系统文件（0.dwg, MC_yuan.dwg等）
├── drawings/             # 图纸文件
├── logs/                 # 日志文件
├── temp/                 # 临时文件
├── temp_scripts/         # 临时脚本
├── 文档/                 # 规范文档
├── CLAUDE.md             # 本文档
└── README.md             # 项目说明
```

---

## 四、必读文档顺序

新对话开始时，按以下顺序阅读：

1. `CAD_快速参考.md` - 协同机制规范
2. `CAD_操作规范.md` - 六大核心规则
3. `CAD_基本操作范式.md` - 五大基本操作范式
4. `CAD_测试规范.md` - 测试规范和八大原则
5. `即时对话.txt` - 当前任务需求

---

## 五、核心原则

### 5.1 1分钟原则

**任何命令运行时间超过1分钟就必须关掉进程重启，因为命令被卡住了。**

这是CAD项目最重要的原则，用于：
- 及时发现命令卡住问题
- 避免长时间等待无响应
- 提高开发和测试效率

### 5.2 范式优先

必须使用范式函数，禁止直接调用COM API。

**范式函数位置**: `system/CAD_basic_operations.py`

常用范式函数：
- `last_obj()` - 获取最后创建的对象
- `set_object_property()` - 设置对象属性
- `get_object_property()` - 获取对象属性
- `select_objects()` - 选择对象
- `delete_objects()` - 删除对象

### 5.3 协同机制

所有操作必须使用协同机制，确保CAD和Python的同步。

**协同机制位置**: `system/CAD_coordination.py`

核心函数：
- `wait_quiescent()` - 等待CAD进入静止状态
- `send_cmd_with_sync()` - 发送命令并同步等待完成

**使用示例**：
```python
from CAD_coordination import wait_quiescent, send_cmd_with_sync

# 执行操作前等待
wait_quiescent(min_quiet=1.0, timeout=15.0)

# 执行操作
draw_tarch_wall((0, 0, 0), (1000, 0, 0), 240)

# 执行操作后等待
wait_quiescent(min_quiet=1.0, timeout=15.0)
```

### 5.4 测试驱动

所有新功能必须有对应测试脚本。

测试脚本必须：
- 放在 `tests/` 目录
- 命名格式：`test_{功能}.py`
- 包含详细的打印输出
- 测量执行时间
- 返回成功/失败状态

### 5.5 文档同步

代码修改必须同步更新文档。

需要更新的文档：
- 修改函数 → 更新函数docstring
- 修改核心代码 → 更新快速参考.md
- 修改范式 → 更新基本操作范式.md
- 修复bug → 更新测试报告

---

## 六、函数编写规范

### 6.1 数据类型转换函数优先

编写函数时，优先采用 `D:/claude-tasks/cad/scripts/CAD_basic.py` 的数据类型转换函数。

**函数位置**：在 `#&&&&%% 第一部分 导入、转换、连接等前置程序` 和 `#&&&&%% 第二部分 列表处理` 之间。

常用转换函数包括：
- 坐标转换函数
- 对象类型转换函数
- 数据格式转换函数

### 6.2 CAD对象属性获取

对CAD对象要从 `D:/claude-tasks/cad/scripts/CAD_basic.py` 的 `cast_object` 获取对象属性，从 `dir(cast_object(ob))` 获取该类对象所有相关属性。

**示例**：
```python
ob.ObjectName
# 'AcDbPolyline'

ob = cast_object(ob)
ob.Coordinates
# (92615.58581555448, 77030.50826206664, 94169.67158404365, 79128.06829721434, ...)
```

### 6.3 天正对象属性操作

对天正对象采用 `D:/claude-tasks/cad/scripts/CAD_basic.py` 的：
- `get_object_property(obj, property_name)` - 获取属性
- `set_object_property(obj, property_name, value)` - 设置属性值

CAD对象也可以使用这种方法获取和修改属性值。

**示例**：
```python
ob.ObjectName
# 'TDbOpening'

get_object_property(ob, "Width")
# 900.0

set_object_property(ob, "Width", 1000.0)
```

### 6.4 命令超时处理

有关天正或CAD命令操作，如果超时60秒仍然不能结束：

1. **尝试增加回车**：增加一个或几个回车以消除默认的连续绘制造成测试卡住
2. **尝试回车回应**：使用回车回应某些不明原因的操作失败
3. **尝试重试**：不超过5次的重试以抵消当时的复杂环境影响

### 6.5 选择方法优先级

有关选择的CAD命令操作，优先调用 `D:/claude-tasks/cad/scripts/CAD_basic.py` 的**第四部分 选择方法**中的函数实现。

函数位置：在 `#&&&&%% 第四部分 选择方法` 和 `#&&&&%% 第五部分 线面分析` 之间。

### 6.6 绘图方法优先级

有关绘图的CAD命令操作，优先调用 `D:/claude-tasks/cad/scripts/CAD_basic.py` 的**第五部分 线面分析**的函数实现。

函数位置：在 `#&&&&%% 第五部分 线面分析` 和 `#&&&&%% 第六部分 综合控制管理` 之间。

### 6.7 图块方法优先级

有关块的CAD命令操作，优先调用 `D:/claude-tasks/cad/scripts/CAD_basic.py` 的**第九部分 CAD图块**的函数实现。

函数位置：在 `#&&&&%% 第九部分 CAD图块` 和 `#&&&&%% 第十部分 非图形对象处理` 之间。

### 6.8 日志记录规范

函数编写应该将重要节点消息发送到日志，以便根据日志反馈来调整函数。

**日志记录原则**：
- 函数开始执行时记录
- 关键操作前后记录
- 错误和异常必须记录
- 性能关键点记录执行时间

**示例**：
```python
def my_cad_function(param1, param2):
    """CAD函数示例"""
    print(f"[开始] my_cad_function - 参数: {param1}, {param2}")

    try:
        # 关键操作前
        print(f"[执行] 正在打开文件: {param1}")
        result = open_file(param1)

        # 关键操作后
        print(f"[完成] 文件已打开: {result}")

        return result
    except Exception as e:
        # 错误记录
        print(f"[错误] my_cad_function 失败: {e}")
        raise
```

**日志级别标记**：
- `[开始]` - 函数开始执行
- `[执行]` - 正在执行某个操作
- `[完成]` - 操作成功完成
- `[错误]` - 发生错误
- `[警告]` - 需要注意的情况
- `[调试]` - 调试信息

---

## 七、测试规范

### 7.1 文件操作函数强制要求

任何DWG文件的新建、打开、复制副本、保存、另存、关闭、整体插入、局部插入等文件操作**都必须**调用 `D:/claude-tasks/cad/scripts/CAD_file_operations.py` 的函数来实现。

**禁止**直接使用COM API进行文件操作。

### 7.2 天正操作函数强制要求

墙的绘制、门的绘制、窗的绘制、标注等天正建筑方面的操作**都必须**从 `D:/claude-tasks/cad/scripts/CAD_file_operations.py` 的函数来实现。

必须使用的函数：
- `draw_tarch_wall()` - 绘制天正墙体
- `insert_tarch_door()` - 插入天正门
- `insert_tarch_window()` - 插入天正窗
- `dim_by_points()` - 天正标注

### 7.3 测试前后状态管理（🔴 三清理规则）

**🚨 强制要求：每次测试任务必须执行三次`cad_zt_zero()`清理**

#### 三清理规则

1. **第1次清理 - 测试开始前**：调用 `cad_zt_zero()` 清理CAD状态
2. **第2次清理 - 测试脚本结束时**：在finally块调用 `cad_zt_zero()`
3. **🔴 第3次清理 - 任务完成汇报前**：再次调用 `cad_zt_zero()`（最容易遗忘！）

#### 完整示例

```python
def test_function():
    # 第1次清理：测试开始前
    print("[1] 清理CAD状态...")
    cad_zt_zero()

    try:
        # 测试步骤
        print("[2] 执行测试...")
        ...
    finally:
        # 第2次清理：测试结束后
        print("[3] 恢复CAD状态...")
        cad_zt_zero()

if __name__ == "__main__":
    # 执行测试
    success = test_function()

    # 第3次清理：任务完成前（如果这是最后一个任务）
    print("[4] 任务完成前最终清理...")
    from CAD_file_operations import cad_zt_zero
    cad_zt_zero()

    # 现在才能汇报任务完成
    print("✅ 任务完成")
    sys.exit(0 if success else 1)
```

#### ⚠️ 为什么需要三次清理？

- **第1次**：确保测试环境干净，避免上次测试的残留影响
- **第2次**：测试后立即清理，释放资源
- **第3次**：整个任务结束后确保系统完全干净（防止进程泄漏）

#### 🔴 违反后果

- 缺少第1次清理 → 测试结果可能不准确
- 缺少第2次清理 → 测试后残留进程
- 缺少第3次清理 → **任务判定为失败**（最容易遗忘！）

### 7.4 测试失败处理

如果测试失败，按以下顺序检查：

1. **检查CAD进程数**：是否超过2（任务管理器查看acad.exe）
   - 如果进程数 ≥ 2，调用 `cad_zt_zero()` 重新开始

2. **检查弹窗处理函数**：`D:/claude-tasks/cad/system/cad_dialog_killer.py` 是否在运行
   - 确保弹窗处理程序正常运行
   - 如未运行，重新启动

3. 重新运行测试

### 7.5 超时处理规则

测试中除非有特别声明，每个操作CAD的命令超过60秒仍然未能结束以执行下一个指令，则：

1. 调用 `cad_zt_oneb()` 终止并清理状态
2. 重新调整函数或脚本
3. 再次测试

**不要等待超过60秒的命令！**

### 7.6 测试完成汇报要求

测试完毕，被要求完成汇报时，必须：

1. 按规范整理测试结果
2. 生成Excel测试报告
3. 生成Markdown测试报告
4. 归档测试DWG文件
5. **将代码上传到GitHub**

---

## 八、文件操作规范

### 8.1 文件存放位置

| 文件类型 | 存放位置 | 说明 |
|---------|---------|------|
| 系统文件 | `xitongwenjian/` | 0.dwg, 1.dwg, 2.dwg, MC_yuan.dwg等 |
| 测试文件 | `tests/test_files/` | 测试生成的DWG文件 |
| **预备测试文件** | `tests/test_files/preset/` | 函数预备测试DWG文件 |
| 测试存档 | `test_reports/test_dwg_files/` | 用于复测的DWG文件存档 |
| 项目图纸 | `drawings/YYYY-MM-DD/` | 按日期分类的项目图纸 |
| 临时文件 | `temp/` | 临时生成的文件，定期清理 |

### 8.2 函数预备测试文件规范（🔴 强制要求）

**每个CAD_file_operations.py函数都必须有对应的预备测试DWG文件和可运行的测试命令。**

#### 预备测试文件要求

1. **文件位置**：`D:/claude-tasks/cad/tests/test_files/preset/`
2. **命名格式**：`preset_{函数类型}.dwg`
3. **数量要求**：根据函数实际情况，可能是0个、1个或多个

#### 预备文件对照表示例

| 函数名 | 预备DWG文件数量 | 文件说明 | 测试命令 |
|--------|----------------|----------|----------|
| `new_file()` | 0个 | 无需（创建新文件） | `python tests/test_new_file.py` |
| `open_file()` | 1个 | `preset_open.dwg` | `python tests/test_open_file.py` |
| `insert_file_as_block()` | 2个 | 源文件+目标文件 | `python tests/test_insert_as_block.py` |
| `insert_region_between_files()` | 2个 | A文件+B文件 | `python tests/test_insert_region_between_files.py` |
| `insert_tarch_door()` | 1个 | 带墙文件 | `python tests/test_insert_tarch_door_triangle.py` |

#### 强制执行规则

- 🔴 **新增函数时**：必须同时创建对应的预备测试文件
- 🔴 **修改函数时**：必须更新预备测试文件并重新测试
- 🔴 **删除函数时**：必须清理对应的预备测试文件
- 🔴 **测试文件清单**：必须更新 `tests/函数测试预备文件清单.md`

#### 快速验证命令

```bash
# 验证单个函数
python D:\claude-tasks\cad\tests\test_{函数名}.py

# 生成所有预备测试文件
python D:\claude-tasks\cad\tests\create_preset_test_files.py

# 运行全部函数测试
python D:\claude-tasks\cad\tests\run_all_function_tests.py

# 生成测试报告
python D:\claude-tasks\cad\tests\generate_excel_report.py
```

#### 文档维护

- **对照表位置**：`D:/claude-tasks/cad/tests/函数测试预备文件清单.md`
- **更新时机**：每次新增/修改/删除函数后
- **必填信息**：函数名、预备文件、测试脚本、测试状态

### 6.2 文件命名规范

**测试文件**：
- `test_{功能}_{描述}.dwg`
- 示例：`test_door_triangle.dwg`, `test_window_rectangle.dwg`

**系统文件**：
- 简短数字或描述性名称
- 示例：`0.dwg`, `MC_yuan.dwg`

**项目图纸**：
- `{项目名}_{日期}.dwg`
- 示例：`project_a_20251113.dwg`

---

## 七、测试规范

### 7.1 测试覆盖率要求

- 核心函数测试覆盖率：100%
- 所有导出函数必须有测试
- 复杂函数需要多个测试场景

### 7.2 测试报告要求

**Excel报告**：
- 使用 `generate_excel_report.py` 生成
- 文件名：`CAD函数测试报告_YYYYMMDD_HHMMSS.xlsx`
- 存放位置：`test_reports/`

**Markdown报告**：
- 详细测试报告：`最终完整测试报告.md`
- 存放位置：`tests/`

### 7.3 测试DWG文件存档

**必须存档**：
- 位置：`test_reports/test_dwg_files/`
- 包含所有测试用到的DWG文件
- 包含README.md说明如何复测

### 7.4 性能基准

测试时参考以下性能基准：

| 操作类型 | 预期时间 | 超时阈值 |
|---------|---------|---------|
| 文件基础操作 | <1秒 | 10秒 |
| 墙体绘制 | 3.4-4.0秒 | 60秒 |
| 门插入 | 2.8秒/门 | 30秒 |
| 窗插入（首次） | 13.5秒 | 60秒 |
| 窗插入（后续） | 7.9-8.1秒 | 30秒 |
| 状态管理 | 3-8秒 | 30秒 |

**超过预期时间2倍以上需要优化。**

### 7.5 函数测试命令手册

**完整手册位置**：`D:/claude-tasks/cad/函数测试命令手册.md`

每个CAD_file_operations.py函数都有详细的测试说明：
- ✅ 测试命令（直接可运行）
- ✅ 预备测试文件位置
- ✅ 文件内容说明
- ✅ 预期测试结果
- ✅ 是否需要手动打开CAD（答案：不需要！）

**快速查找**：
```bash
# 查看完整测试命令手册
cat D:\claude-tasks\cad\函数测试命令手册.md

# 或直接在编辑器中打开
D:\claude-tasks\cad\函数测试命令手册.md
```

**示例**（insert_region_from_file函数）：
```bash
# 测试命令
python D:\claude-tasks\cad\tests\test_insert_region_from_file_optimized.py

# 预备文件
D:/claude-tasks/cad/tests/test_files/preset/preset_region_source.dwg

# 文件内容
- 矩形（10,10到90,90）[在区域内]
- 圆形（250,50）[在区域外]
- 三角形 [在区域内]

# 预期结果
在(150,150)位置有矩形和三角形，没有圆形
```

**使用流程**：
1. 打开函数测试命令手册.md
2. 找到要测试的函数
3. 复制测试命令
4. 在命令行直接运行（无需手动打开CAD）
5. 查看测试结果文件

---

## 八、自动化工具

### 8.1 工具清单

| 工具 | 用途 | 位置 |
|------|------|------|
| `generate_excel_report.py` | 生成Excel测试报告 | tests/ |
| `cad_dialog_killer.py` | CAD弹窗治理 | system/ |
| `CAD_test_framework.py` | 测试框架 | tests/ |
| `run_all_tests.py` | 运行所有测试 | tests/ |

### 8.2 快速命令

```bash
# 生成测试报告
python D:\claude-tasks\cad\tests\generate_excel_report.py

# 运行所有测试
python D:\claude-tasks\cad\tests\run_all_tests.py

# 启动CAD会话
python -c "from CAD_file_operations import start_cad_session; start_cad_session()"

# 杀掉所有CAD进程（紧急情况）
taskkill //F //IM acad.exe

# 运行特定测试
python D:\claude-tasks\cad\tests\test_insert_tarch_door_triangle.py
python D:\claude-tasks\cad\tests\test_insert_tarch_window_rectangle.py
```

---

## 九、关键文件清单

### 9.1 配置文件

- `.claude/CLAUDE_BEHAVIOR_RULES.md` - Claude行为规则（根目录）
- `.claude/commands/cad.md` - CAD命令定义（根目录）
- `cad/即时对话.txt` - 当前任务需求
- `cad/CLAUDE.md` - 本文档

### 9.2 核心代码

| 文件 | 说明 | 行数 |
|------|------|------|
| `scripts/CAD_basic.py` | 基础函数库 | 12958行 |
| `scripts/CAD_file_operations.py` | 文件操作接口 | 24个函数 |
| `system/CAD_coordination.py` | 协同机制 | - |
| `system/CAD_basic_operations.py` | 范式函数 | - |

### 9.3 测试文件

- `test_reports/` - Excel测试报告
- `tests/` - 测试脚本（12个）
- `tests/test_files/` - 测试生成的DWG文件
- `test_reports/test_dwg_files/` - DWG文件存档

### 9.4 文档文件

| 文档 | 说明 |
|------|------|
| `CAD_快速参考.md` | 协同机制规范 |
| `CAD_操作规范.md` | 六大核心规则 |
| `CAD_基本操作范式.md` | 五大基本操作范式 |
| `CAD_测试规范.md` | 测试规范和八大原则 |
| `最终完整测试报告.md` | 完整测试报告 |
| `README.md` | 项目说明 |

---

## 十、常见问题

### 10.1 命令卡住怎么办？

遵循**1分钟原则**：
1. 运行超过1分钟立即终止
2. 使用 `taskkill //F //IM acad.exe` 杀掉CAD进程
3. 检查代码是否缺少结束命令的回车
4. 增加重试机制

### 10.2 COM错误怎么处理？

常见COM错误：`-2147352567 发生意外`

解决方案：
1. 增加重试机制（3次）
2. 增加等待时间
3. 使用 `wait_quiescent()` 确保同步
4. 检查对象是否存在

### 10.3 天正命令如何结束？

天正命令通常需要**额外的回车**来结束连续操作模式：

```python
# 错误：只有一个\n结束当前操作
cmd = f"tgwall\n{p1[0]},{p1[1]}\n{p2[0]},{p2[1]}\n\n"

# 正确：两个\n，第二个退出连续模式
cmd = f"tgwall\n{p1[0]},{p1[1]}\n{p2[0]},{p2[1]}\n\n\n"
```

### 10.4 如何复测？

参考 `test_reports/README.md`：
1. 复制DWG文件到对应位置
2. 运行测试脚本
3. 对比执行时间和结果
4. 检查生成的DWG文件

---

## 十一、环境信息

**测试环境**：
- 操作系统：Windows
- CAD软件：天正建筑 T20V9
- Python版本：Python 3.11
- 必要依赖：pywin32, pandas, openpyxl

**项目位置**：
- 根目录：`D:\claude-tasks\`
- CAD项目：`D:\claude-tasks\cad\`

**最后更新**：2025-11-13

---

## 十二、任务完成前强制检查（🔴 最重要！）

### 🚨 每次说"任务完成"之前必须执行

在向用户汇报"任务完成"、"测试完成"、"开发完成"等任何表示任务结束的消息之前，**必须**先执行以下操作：

#### 1. 强制清理CAD进程

```bash
# 必须执行这个命令
python -c "import sys; sys.path.insert(0, 'D:/claude-tasks/cad/scripts'); from CAD_file_operations import cad_zt_zero; cad_zt_zero()"
```

#### 2. 设置会话结束信号（条件执行）

**🔔 仅在任务要求时设置结束信号**

**⚠️ 执行条件**：仅当任务描述中有以下字段时执行：
```markdown
### 关机信号
该任务结束后强制将 D:/claude-tasks/cad/可以结束对话.txt的内容改为1
```

**设置方法**（条件满足时）：
```python
# ⚠️ 仅在任务明确要求时执行
with open("D:/claude-tasks/cad/可以结束对话.txt", "w", encoding="utf-8") as f:
    f.write("1")
```

**信号文件说明**：
- **文件路径**：`D:\claude-tasks\cad\可以结束对话.txt`
- **初始值**：`0`（监控脚本启动时设置）
- **完成值**：`1`（仅在任务要求时设置）
- **用途**：触发系统关机
- **警告**：设置为1会关机，不要随意设置！

#### 3. 检查清单

**强制检查项**：
- [ ] ✅ 是否执行了`cad_zt_zero()`？
- [ ] ✅ 是否确认所有CAD进程已关闭？
- [ ] ✅ 测试脚本是否有finally块调用`cad_zt_zero()`？
- [ ] ✅ 是否保存了所有测试文件？

**条件检查项（仅在任务明确要求时）**：
- [ ] 🔔 ⚠️ **仅当任务中有"### 关机信号"字段时**，才将`可以结束对话.txt`设置为`1`
- [ ] 🔔 ⚠️ **如果任务中没有此字段，跳过此步骤！**

#### 4. TodoList标准模板

**默认模板（适用于大多数任务）**：

最后三项必须是：
```
- "完成所有测试任务"
- "🔴 任务完成前调用cad_zt_zero()清理" ← 强制项
- "汇报任务完成"
```

**特殊模板（⚠️ 仅当任务中有"### 关机信号"字段时使用）**：

最后四项必须是：
```
- "完成所有测试任务"
- "🔴 任务完成前调用cad_zt_zero()清理" ← 强制项
- "🔔 设置结束信号为1" ← ⚠️条件项（仅任务明确要求时才添加）
- "汇报任务完成"
```

**⚠️ 重要提醒**：如果任务中**没有**"### 关机信号"字段，**绝对不能**添加"设置结束信号为1"这一项！

### ⚠️ 违规后果

**强制规则违反**：
- 如果未执行`cad_zt_zero()`就汇报任务完成 → **任务判定为失败**
- 如果遗漏任何清理步骤 → **必须重新执行任务**

**条件规则违反**：
- 如果任务要求设置结束信号但未设置 → **任务判定为失败**
- 如果任务**未要求**但擅自设置结束信号为`1` → **严重错误（触发意外关机）**

### 📝 记忆口诀

**默认流程 - "完成三部曲：清理、检查、汇报"**（适用于大多数任务）
1. 清理：cad_zt_zero()
2. 检查：检查清单逐项确认
3. 汇报：向用户报告任务完成

**特殊流程 - "完成四部曲：清理、信号、检查、汇报"**（⚠️ 仅当任务有"### 关机信号"字段）
1. 清理：cad_zt_zero()
2. 信号：可以结束对话.txt 设置为 1（⚠️**仅条件满足时才执行**）
3. 检查：检查清单逐项确认
4. 汇报：向用户报告任务完成

**⚠️ 判断依据**：查看任务描述中是否有以下字段
```markdown
### 关机信号
该任务结束后强制将 D:/claude-tasks/cad/可以结束对话.txt的内容改为1
```
- **有此字段** → 使用"完成四部曲"
- **没有此字段** → 使用"完成三部曲"（**绝对不能**设置结束信号）

### 🎯 为什么这条规则如此重要？

1. **防止进程泄漏**：未清理的CAD进程会占用系统资源
2. **确保下次任务干净**：残留进程可能导致下次任务失败
3. **规范养成习惯**：形成标准化的任务完成流程
4. **防止误关机**：结束信号设为1会关机，必须严格条件执行

---

**本文档是CAD项目的特定规范，与根目录的 `D:\claude-tasks\CLAUDE.md` 共同构成完整的开发规范体系。**
