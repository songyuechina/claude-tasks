# CADæµ‹è¯•é—®é¢˜åˆ†ææŠ¥å‘Š

**æ—¥æœŸ**ï¼š2025-11-16
**æµ‹è¯•ä»»åŠ¡**ï¼šç»˜åˆ¶çŸ©å½¢å¢™ä½“å¹¶æ’å…¥çª—æˆ·
**é—®é¢˜**ï¼šä»»åŠ¡å®ŒæˆåCADè¿›ç¨‹æœªå…³é—­ï¼Œå¼¹çª—æ²»ç†æœªç”Ÿæ•ˆ

---

## ä¸€ã€é—®é¢˜ç°è±¡

### é—®é¢˜1ï¼šä»»åŠ¡å®ŒæˆåCADè¿›ç¨‹æœªå…³é—­
- **é¢„æœŸè¡Œä¸º**ï¼šæ‰§è¡Œ `cad_zt_zero()` åï¼Œæ‰€æœ‰CADè¿›ç¨‹åº”è¯¥è¢«å…³é—­
- **å®é™…è¡Œä¸º**ï¼šCADè¿›ç¨‹(PID 31716)ä»ç„¶åœ¨è¿è¡Œï¼Œå¹¶åœç•™åœ¨é”™è¯¯å¼¹çª—ç•Œé¢

### é—®é¢˜2ï¼šå¼¹çª—æ²»ç†è„šæœ¬æœªç”Ÿæ•ˆ
- **é¢„æœŸè¡Œä¸º**ï¼šå¯åŠ¨CADåï¼Œ`cad_dialog_killer.py` åº”è¯¥è‡ªåŠ¨å¯åŠ¨ï¼Œ15ç§’åå…³é—­é”™è¯¯å¼¹çª—
- **å®é™…è¡Œä¸º**ï¼šé”™è¯¯å¼¹çª—ä¸€ç›´æœªè¢«å…³é—­

---

## äºŒã€æ ¹æœ¬åŸå› åˆ†æ

### 2.1 cad_zt_zero() æœªèƒ½å…³é—­CADçš„åŸå› 

**å‡½æ•°è°ƒç”¨é“¾**ï¼š
```
cad_zt_zero()
  â†’ jingchengshu_wenjian()  # æ£€æŸ¥è¿›ç¨‹æ•°
  â†’ close_all_cad_processes()  # å…³é—­æ‰€æœ‰è¿›ç¨‹
```

**é—®é¢˜åˆ†æ**ï¼š

#### ï¼ˆ1ï¼‰å‡½æ•°æ‰§è¡Œä½†æœªäº§ç”Ÿæ•ˆæœ

**ä»£ç ä½ç½®**ï¼š`CAD_file_operations.py:1064-1075`
```python
def cad_zt_zero():
    """ç¡®ä¿CADè¿›ç¨‹æ•°ä¸º0ï¼ˆå…³é—­æ‰€æœ‰CADï¼‰"""
    import sys
    sys.path.append(str(Path(__file__).parent))
    from CAD_basic import jingchengshu_wenjian, close_all_cad_processes

    shu = jingchengshu_wenjian()
    if shu > 0:
        close_all_cad_processes()
```

**é—®é¢˜**ï¼š
1. **æ²¡æœ‰è¿”å›å€¼éªŒè¯**ï¼šå‡½æ•°æ‰§è¡Œåæ²¡æœ‰éªŒè¯CADæ˜¯å¦çœŸæ­£å…³é—­
2. **æ²¡æœ‰æ—¥å¿—è¾“å‡º**ï¼šæ— æ³•é€šè¿‡æ—¥å¿—ç¡®è®¤å‡½æ•°æ˜¯å¦æ‰§è¡Œ
3. **æ²¡æœ‰å¼‚å¸¸å¤„ç†**ï¼š`close_all_cad_processes()` å¤±è´¥æ—¶æ²¡æœ‰é”™è¯¯æç¤º

#### ï¼ˆ2ï¼‰close_all_cad_processes() çš„æ½œåœ¨é—®é¢˜

**ä»£ç ä½ç½®**ï¼š`CAD_basic.py:796-814`
```python
def close_all_cad_processes():
    max_retries = 3
    for attempt in range(max_retries):
        success = True
        for process in psutil.process_iter(['pid', 'name']):
            if process.info['name'] == "acad.exe":
                try:
                    process.kill()
                    time.sleep(2)
                except Exception as e:
                    print(f"å°è¯•å…³é—­ CAD è¿›ç¨‹å¤±è´¥: {e}")
                    success = False
                    break
        if success:
            return
        else:
            print(f"å…³é—­ CAD è¿›ç¨‹å¤±è´¥ï¼Œæ­£åœ¨é‡è¯•... å°è¯•æ¬¡æ•°: {attempt + 1}")
            time.sleep(2)
    print("å¤šæ¬¡å°è¯•å…³é—­ CAD è¿›ç¨‹å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç³»ç»Ÿã€‚")
```

**æ½œåœ¨é—®é¢˜**ï¼š
1. **è¿›ç¨‹å¯èƒ½è¢«ç³»ç»Ÿä¿æŠ¤**ï¼šå¦‚æœCADçª—å£æœ‰å¼¹çª—ï¼Œè¿›ç¨‹å¯èƒ½æ— æ³•é€šè¿‡ `kill()` ç»ˆæ­¢
2. **æ²¡æœ‰ä½¿ç”¨å¼ºåˆ¶ç»ˆæ­¢**ï¼šåº”è¯¥ä½¿ç”¨ `taskkill //F //IM acad.exe` è€Œä¸æ˜¯ `process.kill()`
3. **éªŒè¯CADä»åœ¨è¿è¡Œ**ï¼šæˆ‘æ‰§è¡Œ `tasklist | findstr acad` å‘ç°è¿›ç¨‹31716ä»åœ¨ï¼Œè¯´æ˜ `kill()` å¤±è´¥äº†

**å®é™…éªŒè¯**ï¼š
- æˆ‘æ‰‹åŠ¨æ‰§è¡Œ `taskkill //F //IM acad.exe` åæˆåŠŸå…³é—­äº†CAD
- è¿™è¯´æ˜ `process.kill()` æ–¹æ³•åœ¨CADæœ‰å¼¹çª—æ—¶å¤±æ•ˆ

---

### 2.2 å¼¹çª—æ²»ç†è„šæœ¬æœªå¯åŠ¨çš„åŸå› 

**é—®é¢˜åˆ†æ**ï¼š

#### ï¼ˆ1ï¼‰è„šæœ¬è·¯å¾„é”™è¯¯

**ä»£ç ä½ç½®**ï¼š`CAD_basic.py:756-757`
```python
# å¯åŠ¨ cad_dialog_killer.py
killer_script = os.path.join(os.path.dirname(__file__), "cad_dialog_killer.py")
```

**å®é™…æƒ…å†µ**ï¼š
- `__file__` æŒ‡å‘ `D:\claude-tasks\cad\scripts\CAD_basic.py`
- è®¡ç®—å¾—åˆ°çš„è·¯å¾„ï¼š`D:\claude-tasks\cad\scripts\cad_dialog_killer.py`
- **å®é™…è„šæœ¬ä½ç½®**ï¼š`D:\claude-tasks\cad\system\cad_dialog_killer.py`

**ç»“è®º**ï¼šè·¯å¾„é”™è¯¯å¯¼è‡´è„šæœ¬å¯åŠ¨å¤±è´¥

#### ï¼ˆ2ï¼‰é”™è¯¯æœªè¢«æ•è·å’ŒæŠ¥å‘Š

```python
try:
    subprocess.Popen(
        [sys.executable, killer_script],
        creationflags=subprocess.CREATE_NO_WINDOW
    )
    print("[å¯åŠ¨] cad_dialog_killer å·²å¯åŠ¨")
except Exception as e:
    print(f"[è­¦å‘Š] cad_dialog_killer å¯åŠ¨å¤±è´¥: {e}")
```

**é—®é¢˜**ï¼š
1. å³ä½¿è·¯å¾„é”™è¯¯ï¼Œä»£ç ä¹Ÿä¼šè¾“å‡º"[å¯åŠ¨] cad_dialog_killer å·²å¯åŠ¨"
2. åº”è¯¥åœ¨å¯åŠ¨åéªŒè¯è„šæœ¬æ˜¯å¦çœŸæ­£è¿è¡Œ

---

## ä¸‰ã€æ”¹è¿›æ–¹æ¡ˆ

### 3.1 ä¿®å¤ cad_zt_zero() å‡½æ•°

**æ–¹æ¡ˆ1ï¼šä½¿ç”¨taskkillå¼ºåˆ¶ç»ˆæ­¢**

```python
def cad_zt_zero():
    """ç¡®ä¿CADè¿›ç¨‹æ•°ä¸º0ï¼ˆå…³é—­æ‰€æœ‰CADï¼‰"""
    import sys
    import subprocess
    sys.path.append(str(Path(__file__).parent))
    from CAD_basic import jingchengshu_wenjian

    shu = jingchengshu_wenjian()
    if shu > 0:
        print(f"[æ¸…ç†] æ£€æµ‹åˆ° {shu} ä¸ªCADè¿›ç¨‹ï¼Œæ­£åœ¨å…³é—­...")
        try:
            # ä½¿ç”¨taskkillå¼ºåˆ¶ç»ˆæ­¢
            result = subprocess.run(
                ["taskkill", "//F", "//IM", "acad.exe"],
                capture_output=True,
                text=True
            )
            print(f"[æ¸…ç†] taskkill è¾“å‡º: {result.stdout}")

            # ç­‰å¾…è¿›ç¨‹çœŸæ­£å…³é—­
            import time
            time.sleep(3)

            # éªŒè¯æ˜¯å¦å…³é—­æˆåŠŸ
            shu_after = jingchengshu_wenjian()
            if shu_after == 0:
                print("[æ¸…ç†] CADè¿›ç¨‹å·²å…¨éƒ¨å…³é—­")
                return True
            else:
                print(f"[é”™è¯¯] ä»æœ‰ {shu_after} ä¸ªCADè¿›ç¨‹æœªå…³é—­")
                return False
        except Exception as e:
            print(f"[é”™è¯¯] å…³é—­CADè¿›ç¨‹å¤±è´¥: {e}")
            return False
    else:
        print("[æ¸…ç†] æ²¡æœ‰CADè¿›ç¨‹éœ€è¦å…³é—­")
        return True
```

**æ–¹æ¡ˆ2ï¼šæ”¹è¿› close_all_cad_processes()**

```python
def close_all_cad_processes():
    """å…³é—­æ‰€æœ‰CADè¿›ç¨‹ï¼ˆä½¿ç”¨å¼ºåˆ¶ç»ˆæ­¢ï¼‰"""
    import subprocess

    max_retries = 3
    for attempt in range(max_retries):
        try:
            # ä½¿ç”¨taskkillå¼ºåˆ¶ç»ˆæ­¢æ‰€æœ‰acad.exe
            result = subprocess.run(
                ["taskkill", "//F", "//IM", "acad.exe"],
                capture_output=True,
                text=True,
                timeout=10
            )

            # æ£€æŸ¥è¿”å›ç 
            if result.returncode == 0:
                print("[æˆåŠŸ] CADè¿›ç¨‹å·²å…³é—­")
                time.sleep(2)

                # éªŒè¯æ˜¯å¦çœŸæ­£å…³é—­
                if jingchengshu_wenjian() == 0:
                    return True
            elif result.returncode == 128:
                # æ²¡æœ‰æ‰¾åˆ°è¿›ç¨‹ï¼ˆå·²ç»å…³é—­ï¼‰
                print("[ä¿¡æ¯] æ²¡æœ‰CADè¿›ç¨‹éœ€è¦å…³é—­")
                return True
            else:
                print(f"[è­¦å‘Š] taskkill è¿”å›ç : {result.returncode}")

        except Exception as e:
            print(f"[é”™è¯¯] ç¬¬ {attempt + 1} æ¬¡å…³é—­å¤±è´¥: {e}")

        if attempt < max_retries - 1:
            print(f"[é‡è¯•] ç­‰å¾… 2 ç§’åé‡è¯•...")
            time.sleep(2)

    print("[å¤±è´¥] å¤šæ¬¡å°è¯•å…³é—­CADè¿›ç¨‹å¤±è´¥")
    return False
```

---

### 3.2 ä¿®å¤ start_applicationV9() å¼¹çª—æ²»ç†å¯åŠ¨

**æ–¹æ¡ˆ1ï¼šä¿®æ­£è„šæœ¬è·¯å¾„**

```python
def start_applicationV9(
    PTH: str = r"C:\Tangent\TArchT20V9",
    max_retries: int = 3,
    retry_delay: float = 2.0
) -> subprocess.Popen | None:
    """
    å¯åŠ¨å¤©æ­£ TGStart.exeï¼Œå¤±è´¥é‡è¯•ã€‚
    åŒæ—¶å¯åŠ¨ cad_dialog_killer.pyã€‚
    """
    exe = os.path.join(PTH, "TGStart.exe")
    for attempt in range(1, max_retries + 1):
        try:
            # å¯åŠ¨CAD
            proc = subprocess.Popen([exe], cwd=PTH)
            print("[å¯åŠ¨] å¯åŠ¨å¤©æ­£CAD æˆåŠŸ")

            # å¯åŠ¨ cad_dialog_killer.pyï¼ˆä¿®æ­£è·¯å¾„ï¼‰
            script_dir = Path(__file__).parent.parent  # è¿”å›ä¸Šä¸€çº§åˆ°cadç›®å½•
            killer_script = script_dir / "system" / "cad_dialog_killer.py"

            if not killer_script.exists():
                print(f"[é”™è¯¯] å¼¹çª—æ²»ç†è„šæœ¬ä¸å­˜åœ¨: {killer_script}")
            else:
                try:
                    killer_proc = subprocess.Popen(
                        [sys.executable, str(killer_script)],
                        creationflags=subprocess.CREATE_NO_WINDOW
                    )
                    print(f"[å¯åŠ¨] cad_dialog_killer å·²å¯åŠ¨ (PID: {killer_proc.pid})")

                    # éªŒè¯è¿›ç¨‹æ˜¯å¦çœŸæ­£è¿è¡Œ
                    time.sleep(1)
                    if killer_proc.poll() is None:
                        print("[éªŒè¯] cad_dialog_killer æ­£åœ¨è¿è¡Œ")
                    else:
                        print("[è­¦å‘Š] cad_dialog_killer æ„å¤–é€€å‡º")

                except Exception as e:
                    print(f"[è­¦å‘Š] cad_dialog_killer å¯åŠ¨å¤±è´¥: {e}")

            return proc
        except Exception as e:
            print(f"ç¬¬ {attempt} æ¬¡å¯åŠ¨å¤±è´¥: {e}")
            if attempt < max_retries:
                print(f"ç­‰å¾… {retry_delay:.1f} ç§’åé‡è¯•â€¦")
                time.sleep(retry_delay)

    print(f"å·²è¾¾æœ€å¤§é‡è¯•æ¬¡æ•° ({max_retries})ï¼Œå¯åŠ¨å¤±è´¥ã€‚")
    return None
```

**æ–¹æ¡ˆ2ï¼šæ·»åŠ å¼¹çª—æ²»ç†éªŒè¯å‡½æ•°**

```python
def is_cad_dialog_killer_running():
    """æ£€æŸ¥cad_dialog_killer.pyæ˜¯å¦åœ¨è¿è¡Œ"""
    import psutil

    for proc in psutil.process_iter(['pid', 'name', 'cmdline']):
        try:
            if proc.info['name'] in ['python.exe', 'pythonw.exe']:
                cmdline = proc.info.get('cmdline', [])
                if any('cad_dialog_killer.py' in arg for arg in cmdline):
                    return True, proc.info['pid']
        except (psutil.NoSuchProcess, psutil.AccessDenied):
            continue

    return False, None
```

---

### 3.3 æ·»åŠ æ—¥å¿—ç›‘ç®¡æœºåˆ¶

**æ–¹æ¡ˆï¼šåˆ›å»ºç»Ÿä¸€çš„æ—¥å¿—ç³»ç»Ÿ**

```python
import logging
from pathlib import Path
from datetime import datetime

# æ—¥å¿—é…ç½®
LOG_DIR = Path("D:/claude-tasks/cad/logs")
LOG_DIR.mkdir(exist_ok=True)

LOG_FILE = LOG_DIR / f"cad_operations_{datetime.now().strftime('%Y%m%d')}.log"

logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s [%(levelname)s] %(funcName)s: %(message)s',
    handlers=[
        logging.FileHandler(LOG_FILE, encoding='utf-8'),
        logging.StreamHandler()
    ]
)

logger = logging.getLogger('CAD_Operations')
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```python
def cad_zt_zero():
    """ç¡®ä¿CADè¿›ç¨‹æ•°ä¸º0"""
    logger.info("å¼€å§‹æ¸…ç†CADè¿›ç¨‹")

    shu = jingchengshu_wenjian()
    logger.info(f"å½“å‰CADè¿›ç¨‹æ•°: {shu}")

    if shu > 0:
        success = close_all_cad_processes()
        if success:
            logger.info("CADè¿›ç¨‹æ¸…ç†æˆåŠŸ")
        else:
            logger.error("CADè¿›ç¨‹æ¸…ç†å¤±è´¥")
        return success
    else:
        logger.info("æ²¡æœ‰CADè¿›ç¨‹éœ€è¦æ¸…ç†")
        return True
```

---

## å››ã€æµ‹è¯•éªŒè¯

### 4.1 æ‰‹åŠ¨éªŒè¯ç»“æœ

1. **CADè¿›ç¨‹å…³é—­éªŒè¯**ï¼š
   - æ‰§è¡Œå‰ï¼š`tasklist | findstr acad` â†’ å‘ç°PID 31716
   - æ‰§è¡Œ `taskkill //F //IM acad.exe`
   - æ‰§è¡Œåï¼š`tasklist | findstr acad` â†’ æ— è¾“å‡ºï¼ˆæˆåŠŸå…³é—­ï¼‰

2. **å¼¹çª—æ²»ç†è„šæœ¬è·¯å¾„éªŒè¯**ï¼š
   - é”™è¯¯è·¯å¾„ï¼š`D:\claude-tasks\cad\scripts\cad_dialog_killer.py` ï¼ˆä¸å­˜åœ¨ï¼‰
   - æ­£ç¡®è·¯å¾„ï¼š`D:\claude-tasks\cad\system\cad_dialog_killer.py` ï¼ˆå­˜åœ¨ï¼‰

---

## äº”ã€è§„èŒƒä½“ç³»æ”¹è¿›å»ºè®®

### 5.1 å‡½æ•°ç¼–å†™è§„èŒƒè¡¥å……

åœ¨ `CLAUDE.md` ç¬¬å…­ç« "å‡½æ•°ç¼–å†™è§„èŒƒ"ä¸­å¢åŠ ï¼š

#### 6.9 å…³é”®æ“ä½œéªŒè¯è§„èŒƒ

**æ‰€æœ‰å…³é”®æ“ä½œå¿…é¡»éªŒè¯æ‰§è¡Œç»“æœ**ï¼š

1. **è¿›ç¨‹ç®¡ç†æ“ä½œ**ï¼š
   - å¯åŠ¨è¿›ç¨‹åéªŒè¯æ˜¯å¦çœŸæ­£è¿è¡Œ
   - å…³é—­è¿›ç¨‹åéªŒè¯æ˜¯å¦çœŸæ­£å…³é—­

2. **æ–‡ä»¶æ“ä½œ**ï¼š
   - åˆ›å»ºæ–‡ä»¶åéªŒè¯æ˜¯å¦å­˜åœ¨
   - åˆ é™¤æ–‡ä»¶åéªŒè¯æ˜¯å¦åˆ é™¤

3. **CADæ“ä½œ**ï¼š
   - æ‰§è¡Œå‘½ä»¤åéªŒè¯CADçŠ¶æ€
   - ç­‰å¾…æ“ä½œå®Œæˆ

**ç¤ºä¾‹**ï¼š

```python
# âŒ é”™è¯¯ï¼šæ²¡æœ‰éªŒè¯
def close_cad():
    close_all_cad_processes()

# âœ… æ­£ç¡®ï¼šéªŒè¯ç»“æœ
def close_cad():
    close_all_cad_processes()

    # éªŒè¯æ˜¯å¦å…³é—­æˆåŠŸ
    if jingchengshu_wenjian() == 0:
        print("[æˆåŠŸ] CADå·²å…³é—­")
        return True
    else:
        print("[å¤±è´¥] CADæœªå®Œå…¨å…³é—­")
        return False
```

---

### 5.2 æµ‹è¯•è§„èŒƒè¡¥å……

åœ¨ `CAD_æµ‹è¯•è§„èŒƒ.md` ä¸­å¢åŠ ï¼š

#### åŸåˆ™9ï¼šæµ‹è¯•åéªŒè¯æ¸…ç†

**æ¯ä¸ªæµ‹è¯•ç»“æŸåå¿…é¡»éªŒè¯æ¸…ç†ç»“æœ**ï¼š

```python
def test_function():
    try:
        # æµ‹è¯•æ­¥éª¤
        pass
    finally:
        # æ¸…ç†
        cad_zt_zero()

        # ğŸ”´ æ–°å¢ï¼šéªŒè¯æ¸…ç†ç»“æœ
        time.sleep(2)
        shu = jingchengshu_wenjian()
        if shu > 0:
            print(f"[è­¦å‘Š] æ¸…ç†æœªå®Œæˆï¼Œä»æœ‰ {shu} ä¸ªCADè¿›ç¨‹")
            # å¼ºåˆ¶æ¸…ç†
            subprocess.run(["taskkill", "//F", "//IM", "acad.exe"])
        else:
            print("[éªŒè¯] æ¸…ç†æˆåŠŸï¼Œæ— æ®‹ç•™è¿›ç¨‹")
```

---

## å…­ã€æ€»ç»“

### 6.1 é—®é¢˜æ ¹æº

1. **cad_zt_zero() å¤±æ•ˆ**ï¼š
   - `process.kill()` åœ¨CADæœ‰å¼¹çª—æ—¶å¤±æ•ˆ
   - åº”ä½¿ç”¨ `taskkill //F //IM acad.exe` å¼ºåˆ¶ç»ˆæ­¢

2. **å¼¹çª—æ²»ç†æœªå¯åŠ¨**ï¼š
   - è„šæœ¬è·¯å¾„é”™è¯¯ï¼šä» `scripts/` æŸ¥æ‰¾ï¼Œå®é™…åœ¨ `system/`
   - ç¼ºå°‘å¯åŠ¨åçš„éªŒè¯æœºåˆ¶

### 6.2 ç«‹å³æ‰§è¡Œçš„ä¿®å¤

âœ… **å·²å®Œæˆ**ï¼šæ‰‹åŠ¨å…³é—­æ®‹ç•™çš„CADè¿›ç¨‹

**å¾…æ‰§è¡Œ**ï¼š
1. ä¿®å¤ `cad_zt_zero()` å‡½æ•°
2. ä¿®å¤ `start_applicationV9()` è„šæœ¬è·¯å¾„
3. æ·»åŠ æ—¥å¿—ç³»ç»Ÿ
4. æ›´æ–°è§„èŒƒæ–‡æ¡£

### 6.3 é•¿æœŸæ”¹è¿›

1. **å»ºç«‹å®Œå–„çš„æ—¥å¿—ç³»ç»Ÿ**ï¼šæ‰€æœ‰å…³é”®æ“ä½œéƒ½å†™å…¥æ—¥å¿—
2. **å¼ºåŒ–éªŒè¯æœºåˆ¶**ï¼šå…³é”®æ“ä½œåå¿…é¡»éªŒè¯ç»“æœ
3. **æŒç»­å®Œå–„è§„èŒƒ**ï¼šæ ¹æ®å®é™…æµ‹è¯•åé¦ˆè°ƒæ•´è§„èŒƒ

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**ï¼š2025-11-16
**é—®é¢˜çŠ¶æ€**ï¼šå·²åˆ†æå®Œæˆï¼Œå¾…å®æ–½ä¿®å¤æ–¹æ¡ˆ
